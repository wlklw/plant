<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ¤ç‰©æ—¥èªŒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        /* é é¢åˆ‡æ›å‹•ç•« */
        .page {
            opacity: 1;
            transform: translateX(0);
            transition: all 0.5s ease-in-out;
        }

        .page.hidden {
            opacity: 0;
            transform: translateX(-100%);
            position: absolute;
            pointer-events: none;
            left: 0;
            right: 0;
        }

        /* é¦–é æ¨™é¡Œ */
        .main-title {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* æœå°‹å€åŸŸ */
        .search-section {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .search-container {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
            min-width: 200px;
        }

        .search-input:focus {
            border-color: #667eea;
        }

        .filter-select {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            background: white;
            cursor: pointer;
        }

        /* æ¤ç‰©å¡ç‰‡ç•«å»Š */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .plant-card {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
        }

        .plant-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .plant-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .plant-card:hover::before {
            transform: scaleX(1);
        }

        .plant-image {
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            border-radius: 15px;
            margin-bottom: 15px;
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
        }

        .plant-image::after {
            content: 'ğŸ“·';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            color: #ccc;
        }

        .plant-name {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .plant-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
        }

        .last-update {
            background: #e8f4fd;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .record-count {
            font-weight: 500;
            color: #667eea;
        }

        .status-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4CAF50;
        }

        .status-indicator.warning {
            background: #FF9800;
        }

        .status-indicator.alert {
            background: #F44336;
        }

        /* åˆªé™¤æŒ‰éˆ•åœ¨æ¤ç‰©å¡ç‰‡ä¸Š */
        .delete-plant-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 14px;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease;
            z-index: 10;
        }

        .plant-card:hover .delete-plant-btn {
            opacity: 1;
            transform: scale(1);
        }

        .delete-plant-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        /* æ—¥èªŒé é¢ */
        .journal-page {
            color: white;
        }

        .journal-header {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            color: #333;
        }

        .back-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .back-button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .breadcrumb {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
        }

        .plant-title {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .plant-main-image {
            width: 100px;
            height: 100px;
            background: #f0f0f0;
            border-radius: 15px;
            background-size: cover;
            background-position: center;
        }

        .plant-main-info h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #333;
        }

        .plant-stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .journal-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .journal-actions .btn {
            flex: none;
            padding: 8px 16px;
            font-size: 14px;
        }

        /* æ™‚é–“è»¸ */
        .timeline {
            position: relative;
            padding-left: 40px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(255,255,255,0.3);
        }

        .timeline-item {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            position: relative;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            color: #333;
            transition: all 0.3s ease;
        }

        .timeline-item:hover {
            transform: translateX(10px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 17px;
            top: 30px;
            width: 12px;
            height: 12px;
            background: #667eea;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .record-date {
            font-size: 1.1rem;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
        }

        .record-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .record-image {
            width: 100%;
            height: 150px;
            background: #f0f0f0;
            border-radius: 15px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .record-image:hover {
            transform: scale(1.05);
        }

        .record-text {
            font-size: 1rem;
            line-height: 1.6;
            color: #555;
        }

        /* åœ–ç‰‡æ”¾å¤§æ¨¡æ…‹æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90%;
        }

        .modal-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 10px;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #667eea;
        }

        /* æ·»åŠ æ¤ç‰©æŒ‰éˆ• */
        .add-plant-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .add-plant-btn:hover {
            transform: scale(1.1);
            background: #5a67d8;
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
        }

        /* æ·»åŠ /ç·¨è¼¯æ¤ç‰©è¡¨å–®æ¨¡æ…‹æ¡† */
        .form-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            overflow-y: auto;
        }

        .form-modal-content {
            background: white;
            margin: 5vh auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            position: relative;
        }

        .form-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .form-close {
            position: absolute;
            top: 20px;
            right: 25px;
            color: white;
            font-size: 28px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .form-close:hover {
            transform: scale(1.2);
        }

        .form-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .image-upload-area {
            border: 2px dashed #e0e0e0;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-upload-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .image-upload-area.dragover {
            border-color: #667eea;
            background: #e8f2ff;
        }

        .upload-icon {
            font-size: 3rem;
            color: #ccc;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #666;
            font-size: 1rem;
        }

        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .preview-item {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
        }

        .preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(244, 67, 54, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .preview-item:hover .preview-remove {
            opacity: 1;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .main-title {
                font-size: 2rem;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .search-input,
            .filter-select {
                width: 100%;
            }
            
            .gallery {
                grid-template-columns: 1fr;
            }
            
            .plant-title {
                flex-direction: column;
                text-align: center;
            }
            
            .plant-stats {
                justify-content: center;
            }
            
            .timeline {
                padding-left: 20px;
            }
            
            .timeline::before {
                left: 10px;
            }

            .timeline-item::before {
                left: 7px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="gallery-page" class="page">
            <h1 class="main-title">ğŸŒ± æˆ‘çš„æ¤ç‰©æ—¥èªŒ</h1>
            
            <div class="search-section">
                <div class="search-container">
                    <input type="text" class="search-input" id="search-input" placeholder="æœå°‹æ¤ç‰©åç¨±...">
                    <select class="filter-select" id="filter-select">
                        <option value="all">æ‰€æœ‰æ¤ç‰©</option>
                        <option value="healthy">å¥åº·è‰¯å¥½</option>
                        <option value="warning">éœ€è¦é—œæ³¨</option>
                        <option value="alert">éœ€è¦ç…§è­·</option>
                    </select>
                </div>
            </div>
            
            <div class="gallery" id="plant-gallery">
                </div>
        </div>

        <div id="journal-page" class="page hidden journal-page">
            <div class="journal-header">
                <button class="back-button" onclick="showGallery()">â† è¿”å›æ¤ç‰©ç•«å»Š</button>
                <div class="breadcrumb">
                    <a href="#" onclick="showGallery()">é¦–é </a> > <span id="current-plant-name"></span>
                </div>
                
                <div class="plant-title">
                    <div class="plant-main-image" id="main-plant-image"></div>
                    <div class="plant-main-info">
                        <h1 id="journal-plant-name"></h1>
                        <div class="plant-stats">
                            <div class="stat-item">
                                <div class="stat-number" id="total-records">0</div>
                                <div class="stat-label">ç¸½è¨˜éŒ„</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="care-days">0</div>
                                <div class="stat-label">ç…§è­·å¤©æ•¸</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="avg-interval">0</div>
                                <div class="stat-label">å¹³å‡é–“éš”(å¤©)</div>
                            </div>
                        </div>
                        <div class="journal-actions">
                            <button class="btn btn-primary" onclick="addRecord()">ğŸ“ æ–°å¢è¨˜éŒ„</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="timeline" id="timeline">
                </div>
        </div>
    </div>

    <button class="add-plant-btn" onclick="openPlantForm()" title="æ·»åŠ æ–°æ¤ç‰©">+</button>

    <div id="plantFormModal" class="form-modal">
        <div class="form-modal-content">
            <div class="form-header">
                <h2 id="form-title">æ·»åŠ æ–°æ¤ç‰©</h2>
                <span class="form-close" onclick="closePlantForm()">&times;</span>
            </div>
            <div class="form-body">
                <form id="plantForm">
                    <input type="hidden" id="plant-id">
                    <div class="form-group">
                        <label class="form-label" for="plant-name">æ¤ç‰©åç¨± *</label>
                        <input type="text" id="plant-name" class="form-input" required placeholder="ä¾‹å¦‚ï¼šé¾œèƒŒèŠ‹ã€å¤šè‚‰æ¤ç‰©ç­‰">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="plant-status">æ¤ç‰©ç‹€æ…‹</label>
                        <select id="plant-status" class="form-select">
                            <option value="healthy">å¥åº·è‰¯å¥½ ğŸŸ¢</option>
                            <option value="warning">éœ€è¦é—œæ³¨ ğŸŸ¡</option>
                            <option value="alert">éœ€è¦ç…§è­· ğŸ”´</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ä¸»è¦ç…§ç‰‡ *</label>
                        <div class="image-upload-area" id="main-upload-area" onclick="document.getElementById('main-image-input').click()">
                            <input type="file" id="main-image-input" accept="image/*" style="display: none;">
                            <div class="upload-icon">ğŸ“·</div>
                            <div class="upload-text">é»æ“Šé¸æ“‡ä¸»è¦ç…§ç‰‡<br><small>æ”¯æ´ JPGã€PNGã€GIF æ ¼å¼</small></div>
                        </div>
                        <div id="main-image-preview" class="preview-container"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="record-date">é¦–æ¬¡è¨˜éŒ„æ—¥æœŸ</label>
                        <input type="date" id="record-date" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è¨˜éŒ„ç…§ç‰‡</label>
                        <div class="image-upload-area" id="record-upload-area" onclick="document.getElementById('record-images-input').click()">
                            <input type="file" id="record-images-input" accept="image/*" multiple style="display: none;">
                            <div class="upload-icon">ğŸ–¼ï¸</div>
                            <div class="upload-text">é»æ“Šé¸æ“‡è¨˜éŒ„ç…§ç‰‡ï¼ˆå¯å¤šé¸ï¼‰<br><small>æ”¯æ´ JPGã€PNGã€GIF æ ¼å¼</small></div>
                        </div>
                        <div id="record-images-preview" class="preview-container"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="record-text">è¨˜éŒ„å…§å®¹</label>
                        <textarea id="record-text" class="form-textarea" placeholder="æè¿°æ¤ç‰©çš„ç‹€æ³ã€ç…§è­·å¿ƒå¾—æˆ–è§€å¯Ÿè¨˜éŒ„..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closePlantForm()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜æ¤ç‰©</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="imageModal" class="modal" onclick="closeModal()">
        <span class="close">&times;</span>
        <div class="modal-content">
            <img class="modal-image" id="modalImage">
        </div>
    </div>

    <script>
        let plants = [];
        let currentPlantId = null;
        let isEditing = false;
        let mainImageFile = null;
        let recordImageFiles = [];

        // DOM å…ƒç´ 
        const galleryPage = document.getElementById('gallery-page');
        const journalPage = document.getElementById('journal-page');
        const plantGallery = document.getElementById('plant-gallery');
        const plantFormModal = document.getElementById('plantFormModal');
        const plantForm = document.getElementById('plantForm');
        const formTitle = document.getElementById('form-title');
        const addPlantBtn = document.querySelector('.add-plant-btn');
        const searchInput = document.getElementById('search-input');
        const filterSelect = document.getElementById('filter-select');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadPlants();
            renderGallery();
        });

        // é é¢åˆ‡æ›å‡½å¼
        function showGallery() {
            galleryPage.classList.remove('hidden');
            journalPage.classList.add('hidden');
            addPlantBtn.style.display = 'block';
            currentPlantId = null;
            renderGallery();
        }

        function showJournal(plantId) {
            const plant = plants.find(p => p.id === plantId);
            if (!plant) return;

            currentPlantId = plantId;
            galleryPage.classList.add('hidden');
            journalPage.classList.remove('hidden');
            addPlantBtn.style.display = 'none';

            // æ¸²æŸ“æ—¥èªŒé é¢
            document.getElementById('current-plant-name').textContent = plant.name;
            document.getElementById('journal-plant-name').textContent = plant.name;
            document.getElementById('main-plant-image').style.backgroundImage = `url('${plant.mainImage}')`;
            
            renderJournalTimeline(plant);
            updateJournalStats(plant);
        }

        function openPlantForm(plant = null) {
            plantForm.reset();
            document.getElementById('main-image-preview').innerHTML = '';
            document.getElementById('record-images-preview').innerHTML = '';
            mainImageFile = null;
            recordImageFiles = [];

            if (plant) {
                isEditing = true;
                formTitle.textContent = 'æ–°å¢è¨˜éŒ„';
                document.getElementById('plant-id').value = plant.id;
                document.getElementById('plant-name').value = plant.name;
                document.getElementById('plant-status').value = plant.status;
                
                // éš±è—ä¸ç›¸é—œçš„æ¬„ä½
                document.querySelector('label[for="plant-name"]').style.display = 'none';
                document.getElementById('plant-name').style.display = 'none';
                document.querySelector('label[for="plant-status"]').style.display = 'none';
                document.getElementById('plant-status').style.display = 'none';
                document.querySelector('label[for="main-image-input"]').style.display = 'none';
                document.getElementById('main-upload-area').style.display = 'none';
                document.getElementById('record-date').valueAsDate = new Date(); // é è¨­ç‚ºä»Šå¤©
            } else {
                isEditing = false;
                formTitle.textContent = 'æ·»åŠ æ–°æ¤ç‰©';
                document.getElementById('plant-id').value = '';
                document.querySelector('label[for="plant-name"]').style.display = 'block';
                document.getElementById('plant-name').style.display = 'block';
                document.querySelector('label[for="plant-status"]').style.display = 'block';
                document.getElementById('plant-status').style.display = 'block';
                document.querySelector('label[for="main-image-input"]').style.display = 'block';
                document.getElementById('main-upload-area').style.display = 'block';
            }
            plantFormModal.style.display = 'block';
        }

        function closePlantForm() {
            plantFormModal.style.display = 'none';
        }

        // æ•¸æ“šå­˜å–
        function savePlants() {
            localStorage.setItem('myPlantJournal', JSON.stringify(plants));
        }

        function loadPlants() {
            const storedPlants = localStorage.getItem('myPlantJournal');
            if (storedPlants) {
                plants = JSON.parse(storedPlants);
            }
        }

        // æ¸²æŸ“ç•«å»Š
        function renderGallery() {
            const searchTerm = searchInput.value.toLowerCase();
            const filterStatus = filterSelect.value;
            plantGallery.innerHTML = '';

            const filteredPlants = plants.filter(plant => {
                const matchesSearch = plant.name.toLowerCase().includes(searchTerm);
                const matchesFilter = filterStatus === 'all' || plant.status === filterStatus;
                return matchesSearch && matchesFilter;
            });

            if (filteredPlants.length === 0) {
                plantGallery.innerHTML = `<p style="text-align: center; color: white; opacity: 0.8; margin-top: 50px;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ¤ç‰©... ğŸª´</p>`;
                return;
            }

            filteredPlants.forEach(plant => {
                const card = document.createElement('div');
                card.className = 'plant-card';
                card.setAttribute('data-id', plant.id);
                
                const lastRecord = plant.records.length > 0 ? plant.records[plant.records.length - 1] : null;
                const lastUpdate = lastRecord ? new Date(lastRecord.date).toLocaleDateString('zh-TW') : 'ç„¡è¨˜éŒ„';

                let statusClass = '';
                if (plant.status === 'warning') statusClass = 'warning';
                if (plant.status === 'alert') statusClass = 'alert';
                
                card.innerHTML = `
                    <button class="delete-plant-btn" onclick="event.stopPropagation(); deletePlant('${plant.id}')">âœ•</button>
                    <div class="status-indicator ${statusClass}"></div>
                    <div class="plant-image" style="background-image: url('${plant.mainImage}');"></div>
                    <div class="plant-name">${plant.name}</div>
                    <div class="plant-info">
                        <span class="last-update">æœ€æ–°ï¼š${lastUpdate}</span>
                        <span class="record-count">å…± ${plant.records.length} å‰‡è¨˜éŒ„</span>
                    </div>
                `;
                card.onclick = () => showJournal(plant.id);
                plantGallery.appendChild(card);
            });
        }

        // æ¸²æŸ“æ—¥èªŒæ™‚é–“è»¸
        function renderJournalTimeline(plant) {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';
            
            if (plant.records.length === 0) {
                timeline.innerHTML = `<p style="text-align: center; color: white; opacity: 0.8; margin-top: 50px;">é‚„æ²’æœ‰ä»»ä½•è¨˜éŒ„ï¼Œé»æ“Šã€Œæ–°å¢è¨˜éŒ„ã€æŒ‰éˆ•ä¾†å»ºç«‹ç¬¬ä¸€å‰‡å§ï¼</p>`;
                return;
            }

            plant.records.sort((a, b) => new Date(b.date) - new Date(a.date));

            plant.records.forEach(record => {
                const item = document.createElement('div');
                item.className = 'timeline-item';
                
                const formattedDate = new Date(record.date).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
                
                let imagesHTML = '';
                if (record.images && record.images.length > 0) {
                    imagesHTML = `<div class="record-images">
                        ${record.images.map(imgSrc => `<div class="record-image" style="background-image: url('${imgSrc}');" onclick="event.stopPropagation(); openModal('${imgSrc}')"></div>`).join('')}
                    </div>`;
                }

                item.innerHTML = `
                    <div class="record-date">ğŸ“… ${formattedDate}</div>
                    ${record.text ? `<div class="record-text">${record.text.replace(/\n/g, '<br>')}</div>` : ''}
                    ${imagesHTML}
                `;
                timeline.appendChild(item);
            });
        }

        // æ›´æ–°æ—¥èªŒçµ±è¨ˆæ•¸æ“š
        function updateJournalStats(plant) {
            const totalRecords = plant.records.length;
            document.getElementById('total-records').textContent = totalRecords;
            
            if (totalRecords > 0) {
                const firstDate = new Date(plant.records[0].date);
                const lastDate = new Date(plant.records[totalRecords - 1].date);
                const diffTime = Math.abs(lastDate - firstDate);
                const careDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                document.getElementById('care-days').textContent = careDays;

                const intervals = [];
                for (let i = 1; i < totalRecords; i++) {
                    const prevDate = new Date(plant.records[i - 1].date);
                    const currDate = new Date(plant.records[i].date);
                    intervals.push(Math.abs(currDate - prevDate) / (1000 * 60 * 60 * 24));
                }
                const avgInterval = intervals.length > 0 ? (intervals.reduce((sum, val) => sum + val, 0) / intervals.length).toFixed(1) : 0;
                document.getElementById('avg-interval').textContent = avgInterval;

            } else {
                document.getElementById('care-days').textContent = '0';
                document.getElementById('avg-interval').textContent = '0';
            }
        }

        // è™•ç†è¡¨å–®æäº¤
        plantForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const plantName = document.getElementById('plant-name').value;
            const plantStatus = document.getElementById('plant-status').value;
            const recordDate = document.getElementById('record-date').value;
            const recordText = document.getElementById('record-text').value;

            if (isEditing) {
                // æ–°å¢è¨˜éŒ„
                const plant = plants.find(p => p.id === currentPlantId);
                const record = {
                    date: recordDate || new Date().toISOString().split('T')[0],
                    text: recordText,
                    images: await Promise.all(recordImageFiles.map(fileToBase64)),
                };
                plant.records.push(record);
            } else {
                // æ–°å¢æ¤ç‰©
                if (!mainImageFile) {
                    alert('è«‹é¸æ“‡ä¸»è¦ç…§ç‰‡ï¼');
                    return;
                }
                const newPlant = {
                    id: Date.now().toString(),
                    name: plantName,
                    status: plantStatus,
                    mainImage: await fileToBase64(mainImageFile),
                    records: [],
                };
                if (recordDate || recordText || recordImageFiles.length > 0) {
                    newPlant.records.push({
                        date: recordDate || new Date().toISOString().split('T')[0],
                        text: recordText,
                        images: await Promise.all(recordImageFiles.map(fileToBase64)),
                    });
                }
                plants.push(newPlant);
            }

            savePlants();
            closePlantForm();
            if (currentPlantId) {
                showJournal(currentPlantId);
            } else {
                renderGallery();
            }
        });

        // è™•ç†åˆªé™¤æ¤ç‰©
        function deletePlant(plantId) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™æ ªæ¤ç‰©åŠå…¶æ‰€æœ‰è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                plants = plants.filter(p => p.id !== plantId);
                savePlants();
                showGallery();
            }
        }

        // è™•ç†æ–°å¢è¨˜éŒ„
        function addRecord() {
            const plant = plants.find(p => p.id === currentPlantId);
            if (plant) {
                openPlantForm(plant);
            }
        }
        
        // è™•ç†åœ–ç‰‡ä¸Šå‚³
        const mainImageInput = document.getElementById('main-image-input');
        const recordImagesInput = document.getElementById('record-images-input');

        mainImageInput.addEventListener('change', (e) => handleImageUpload(e, 'main'));
        recordImagesInput.addEventListener('change', (e) => handleImageUpload(e, 'record'));

        function handleImageUpload(event, type) {
            const files = event.target.files;
            if (files.length > 0) {
                const previewContainer = document.getElementById(type === 'main' ? 'main-image-preview' : 'record-images-preview');
                previewContainer.innerHTML = '';
                
                if (type === 'main') {
                    mainImageFile = files[0];
                    renderImagePreview(mainImageFile, previewContainer, type);
                } else {
                    recordImageFiles = Array.from(files);
                    recordImageFiles.forEach(file => renderImagePreview(file, previewContainer, type));
                }
            }
        }

        function renderImagePreview(file, container, type) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.innerHTML = `<img src="${e.target.result}" class="preview-image">`;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'preview-remove';
                removeBtn.textContent = 'âœ•';
                removeBtn.onclick = () => {
                    previewItem.remove();
                    if (type === 'main') {
                        mainImageFile = null;
                        document.getElementById('main-image-input').value = '';
                    } else {
                        const index = recordImageFiles.indexOf(file);
                        if (index > -1) {
                            recordImageFiles.splice(index, 1);
                        }
                    }
                };
                previewItem.appendChild(removeBtn);
                container.appendChild(previewItem);
            };
            reader.readAsDataURL(file);
        }

        // å°‡æª”æ¡ˆè½‰æ›ç‚º Base64 å­—ä¸²
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        // æœå°‹åŠç¯©é¸äº‹ä»¶ç›£è½
        searchInput.addEventListener('input', renderGallery);
        filterSelect.addEventListener('change', renderGallery);

        // åœ–ç‰‡æ”¾å¤§æ¨¡æ…‹æ¡†
        function openModal(imageSrc) {
            imageModal.style.display = 'block';
            modalImage.src = imageSrc;
        }

        function closeModal() {
            imageModal.style.display = 'none';
            modalImage.src = '';
        }
    </script>
</body>
</html>
